---
title: "Class Outline"
output: 
  html_document:
    theme: readable
    toc: true
    toc_float: true
    
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(eval = FALSE)
```

```{=html}
<style type="text/css">
  .figure {
    float: right;
    text-align: center;
    width: 50%;
  }
</style>
```

```{r fig.cap = "artwork by @allison_horst", echo=FALSE, eval = TRUE}
knitr::include_graphics('C:/Users/clam/Documents/github/intro-ggplot2/images/ggplot2_masterpiece.png')
```

This module will introduce ggplot2 syntax to create a bar graph and facetting. Extensions such as plotting using `ggplotly()` will also be demonstrated. 

Data for the code-a-long is a munged OFM April 1 dataset which you can find [here](). For more information about April 1 Estimates and its original format see [Office of Financial Management (OFM)](https://www.ofm.wa.gov/washington-data-research/population-demographics/population-estimates/april-1-official-population-estimates). 

Handy keyboard shortcuts for Windows:

- Comment a line or lines: `Ctrl+Shift+C`
- Toggle cursor between script and console panes: `Ctrl+1` and `Ctrl+2`
- Create arrow `<-`: `Alt+-`

# Intro to ggplot2

You can copy and paste snippets from this outline into your script or type along. Some code may differ from what will be presented during the session.

## Setup
Load the first three libraries. The fourth, `extrafont`, is optional depending on if you installed the package and followed additional steps [here](https://psrc.github.io/intro-ggplot2/content/using_fonts.html).
```{r}
library(openxlsx)
library(ggplot2)
library(scales)
library(extrafont) # optional
```


You can replace the path below to where you've stored the data. Use forward slashes `/` or double back slashes `\\`
```{r}
df <- read.xlsx("T:/2020December/christy/ofm_april1_population_final_tidied.xlsx", detectDates = TRUE)
```

## Bar Graph

To create a simple bar graph, we'll use a subset of the the data. Query for only total county estimates (where column `Filter` equals 1)
```{r}
df1 <- df[df$Filter == 1, ]
```

### Initiate ggplot
```{r}
g <- ggplot()
```

### Geoms

Geoms are geometric objects drawn to represent data such as lines, bars, and points[^1]. Within the geom function is a place to assign aesthetics `aes()`. `aes()` takes a handful of arguments and it will vary across geoms. Use the console to look up help on `geom_col()` and find its aesthetics.

[^1]: Data Source: R Graphics Cookbook, pg 409

```{r}
# adding a geom and using aesthetics
g +
  geom_col(data = df1, 
           aes(x = Year_chr, y = Estimate, fill = County),
           color = "black",
           alpha = .5,
           position = "stack"
           )
```

### Scales

Scales control the mapping from the values of the data space to the values of the aesthetic space[^2]. When we map a variable, default settings are used. To change the default and customize those aesthetics, apply a scale function. 

[^2]: Data Source: R Graphics Cookbook, pg 409

Most follow the format: `scale_{aesthetic}_{method}` or `scale_{aesthetic}_{datatype}` 

```{r}
# Using brewers to change the color palette

g +
  geom_col(data = df1, 
           aes(x = Year_chr, y = Estimate, fill = County),
           color = "black",
           alpha = .5,
           position = "stack"
  ) +
  scale_fill_brewer(palette = "Accent")
```

```{r}
# Creating and using a custom color palette

my.pal <- c('#f6eff7','#bdc9e1','#67a9cf','#02818a')

g +
  geom_col(data = df1, 
           aes(x = Year_chr, y = Estimate, fill = County),
           color = "black",
           alpha = .5,
           position = "stack"
  ) +
  scale_fill_manual(values = my.pal)
```

```{r}
# Formatting the axis scales

g +
  geom_col(data = df1, 
           aes(x = Year_chr, y = Estimate, fill = County),
           color = "black",
           alpha = .5,
           position = "stack"
  ) +
  scale_fill_manual(values = my.pal) +
  scale_y_continuous(labels = label_comma())
```

```{r}
# Setting breaks and new labels for axis
g +
  geom_col(data = df1, 
           aes(x = Year_chr, y = Estimate, fill = County),
           color = "black",
           alpha = .5,
           position = "stack"
  ) +
  scale_fill_manual(values = my.pal) +  
  scale_y_continuous(labels = c("None", "A lot"),
                     breaks = c(0, 4e+06)) +
  scale_x_discrete(labels = c(2010:2019, "Worst Year Ever"))
```

### Theme

The theme function controls the non-data part of your plot such as titles, labels, fonts, background, gridlines, and legends. Depending on what you’re changing, you’ll have to wrap your specs with one of the following functions: 

  - `element_line()`: modify the line elements of the theme
  - `element_text()`: to modify the text elements
  - `element_rect()`: to modify the rectangle elements
  - `element_blank()`: to remove the element

```{r}
# Changing the non-data part  
g +
  geom_col(data = df1, 
           aes(x = Year_chr, y = Estimate, fill = County),
           color = "black",
           alpha = .5,
           position = "stack"
  ) +
  scale_fill_manual(values = my.pal) +
  scale_y_continuous(labels = c("None", "A lot"),
                     breaks = c(0, 4e+06)) +
  scale_x_discrete(labels = c(2010:2019, "Worst Year Ever")) +  
  theme(axis.text.x = element_text(angle = 45, 
                                   hjust =  1, 
                                   vjust = 1, 
                                   family = "Comic Sans MS", 
                                   size = 8),
        axis.ticks.x = element_blank(),
        legend.position = c(.5, .5),
        text = element_text(family = "Comic Sans MS")) 
```

### Labs

An easy way to include plot titles, change axis labels, or legend titles is to use the labs function.

```{r}
# Labels
g +
  geom_col(data = df1, 
           aes(x = Year_chr, y = Estimate, fill = County),
           color = "black",
           alpha = .5,
           position = "stack"
  ) +
  scale_fill_manual(values = my.pal) +
  scale_y_continuous(labels = c("None", "A lot"),
                     breaks = c(0, 4e+06)) +
  scale_x_discrete(labels = c(2010:2019, "Worst Year Ever")) +  
  theme(axis.text.x = element_text(angle = 45, 
                                   hjust =  1, 
                                   vjust = 1, 
                                   family = "Comic Sans MS", 
                                   size = 8),
        axis.ticks.x = element_blank(),
        legend.position = c(.5, .5),
        text = element_text(family = "Comic Sans MS")) +
  labs(title = "My Plot", 
       x = "Year", 
       y = NULL, 
       caption = "footnote", 
       subtitle = "My subtitle")
```


### Save the plot as a bitmap output file (e.g. .jpg)
```{r}
# set your ggplot and everything that's chained to it to a variable
my.plot <- g + <other stuff>

ggsave("T:/2020December/christy/my_plot.jpg", plot = my.plot)
```

## Other geoms

```{r}


```


## Facets

Also known as Trellis displays, facets are an easy way to display groups of data alongside each other.

### Facet Wrap

You can use `facet_wrap()` if you want your subplots laid out horizonally and wrapped around. Put your variable(s) within `vars()`. `vars()` like the `aes()` checks to see what the unique values of your variable(s) are and allows `facet_` to do what it needs to do to subplot. 

```{r}
g +
  geom_col(data = df1, 
           aes(x = , y = )
           ) +
  facet_wrap(vars(), ncol = , scales = )
```

*For longtime users of ggplot2, you may have used the `~` notation in `facet_` functions. You've probably seen the `~` used in books or stack overflow answers. You can still get away with using `~` but it has been soft-deprecated and superceded with `vars()` like in the examples shown. 

### Facet Grid

Use `facet_grid()` when you want to split by at least two variables that generate vertical and horizontal panels.

Let's create a facet grid where vertical panels are based on Filter values (Total County, Unincorporated County, and Incorporated County jurisdiction) and horizontal panels based on Counties. Query `df` for all records except for individual cities and towns.
```{r}
df2 <- df[df$Filter != 4, ]
```


```{r}
g +
  geom_col(data = df2, 
           aes(x = , y = )
  ) +
  facet_grid(rows = vars(), cols = vars()) 
  
```



# Extensions 

## Plotly

Plotly for R is a separate graphing library that specializes in interactive graphs. Plotly is part of the [htmlwidgets](https://www.htmlwidgets.org/showcase_plotly.html) family -- libraries that are originally written in JavaScript then bound with R. It has its own set of graphing functions and syntax but it doesn't mean you have to learn a completely new system inorder to have interactive graphs! 

Load the `plotly` and `htmlwidgets` library
```{r}
library(ggplot2)
library(plotly)
library(htmlwidgets)
```

Just use Plotly's `ggplotly()` around your ggplot object to integrate ggplot2 with Plotly.
```{r}
p <- g +
  geom_col(data = , 
           aes(x = , y = , fill = )
  )

p1 <- ggplotly(p)

# when saving a ggplotly or plotly object to disk, use a .html extension
saveWidget(p1, file="T:/2020December/christy/my_plot.html")  
```

## Others

Sometimes ggplot2 on its own can only do so much. Where there is a gap, R users have built on top of ggplot2 and created their own libraries to enhance ggplot2 graphs either with animation, better fitted labeling, or specialty geoms to name a few. You can check out the ggplot2 extension gallery here:

[https://exts.ggplot2.tidyverse.org/gallery/](https://exts.ggplot2.tidyverse.org/gallery/)

